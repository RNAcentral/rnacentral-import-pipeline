#!/usr/bin/env bash

set -euo pipefail
IFS=$'\n\t'

function usage ()
{
  echo "Usage :  $0 [options] [--]

    Options:
    -h|help       Display this message
    -v            Add a variable for psql"

}

pg_args=''
while getopts ":hv" opt
do
  case $opt in

  h )
    usage
    exit 0
    ;;

  v )
    pg_args="$pg_args -v $OPTARG"
    ;;

  * )
    echo -e "\n  Option does not exist : $OPTARG\n"
    usage
    exit 1
    ;;

  esac
done
shift $(($OPTIND-1))

query="$1"
size="$2"

psql -v ON_ERROR_STOP=1 $pg_args -f "$query" "$PGDATABASE" > raw.json
json2fasta.py raw.json rnacentral.fasta
seqkit shuffle --two-pass rnacentral.fasta > shuffled.fasta
seqkit split --two-pass --by-size "$size" --out-dir 'parts/' shuffled.fasta
